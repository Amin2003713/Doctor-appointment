@page "/login"
@layout UnAuthMainLayout


<MudPaper Class="pa-6 mx-auto mt-12" Style="max-width:420px" Elevation="8" dir="rtl">
    <MudText Typo="Typo.h5" Class="mb-4">ورود</MudText>

    <EditForm EditContext="_editContext" OnValidSubmit="DoLogin">
        <DataAnnotationsValidator/>
        <MudTextField @bind-Value="_model.Email"
                      Label="ایمیل"
                      For="@(() => _model.Email)"
                      Required="true"
                      Immediate="true"
                      Variant="Variant.Outlined"
                      FullWidth="true"/>
        <MudTextField @bind-Value="_model.Password"
                      Label="رمز عبور"
                      For="@(() => _model.Password)"
                      Required="true"
                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                      OnAdornmentClick="() => _showPassword = !_showPassword"
                      Variant="Variant.Outlined"
                      FullWidth="true"
                      Class="mt-3"/>

        <MudCheckBox T="bool" bind-Value="_rememberMe" Label="من را به خاطر بسپار" Class="mt-2"/>

        <MudButton OnClick="DoLogin"
                   Disabled="@(_busy || !_editContext.Validate())"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Class="mt-4"
                   FullWidth="true"
                   StartIcon="@Icons.Material.Filled.Login">
            @(_busy ? "در حال ورود..." : "ورود")
        </MudButton>

        @if (!string.IsNullOrEmpty(_message))
        {
            <MudAlert Severity="@_severity" Class="mt-3">@_message</MudAlert>
        }
    </EditForm>
</MudPaper>

@code {
    private readonly LoginVm                 _model = new();
    private          EditContext             _editContext;
    private          bool                    _busy;
    private          bool                    _showPassword;
    private          bool                    _rememberMe = true;
    private          string                  _message;
    private          Severity                _severity = Severity.Error;
    private          CancellationTokenSource _cts;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private async Task DoLogin()
    {
        if (_busy) return;
        _message = string.Empty;
        _cts?.Dispose();
        _cts = new CancellationTokenSource();

        try
        {
            _busy = true;

            var ok = await Auth.LoginAsync(_model.Email , _model.Password , _cts.Token);

            if (ok)
            {
                _severity = Severity.Success;
                _message  = "ورود با موفقیت انجام شد.";
                // optional: redirect to last requested or home
                NavManager.NavigateTo("/" , forceLoad: true);
            }
            else
            {
                _severity = Severity.Error;
                _message  = "ورود ناموفق بود! ایمیل یا رمز عبور را بررسی کنید.";
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception)
        {
            _severity = Severity.Error;
            _message  = "خطا در برقراری ارتباط با سرور.";
        }
        finally
        {
            _busy = false;
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }

    private sealed class LoginVm
    {
        [Required(ErrorMessage = "ایمیل الزامی است.")] [EmailAddress(ErrorMessage = "ایمیل نامعتبر است.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "رمز عبور الزامی است.")] [MinLength(6 , ErrorMessage = "حداقل ۶ کاراکتر.")]
        public string Password { get; set; } = string.Empty;
    }

}
