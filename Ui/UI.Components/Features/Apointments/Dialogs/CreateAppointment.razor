@using System.Globalization
@using App.Applications.Appointments.Requests
@using App.Applications.Schedules.Requests.GetSlots
@using App.Applications.Users.Requests.UserInfos
@using App.Applications.Users.Requests.UserQueries
@implements IDisposable

<MudDialog>
    <TitleContent>ایجاد نوبت جدید</TitleContent>

    <DialogContent>
        <MudStack Class="gap-2" Justify="Justify.SpaceBetween">

            @* --- Patient field --- *@
            @if (IsPatient || UserId.HasValue)
            {
                <MudTextField
                    Label="بیمار"
                    Value="@(_selectedUser is null ? string.Empty : $"{_selectedUser.FullName} ({_selectedUser.Username})")"
                    Variant="Variant.Text"
                    Required="true"
                    ReadOnly="true"
                    Disabled="@(!_usersLoaded)"
                />
            }
            else
            {
                <MudSelect T="UserListItemResponse"
                           Label="بیمار"
                           Variant="Variant.Text"
                           Required="true"
                           ReadOnly="false"
                           Disabled="@(!_usersLoaded)"
                           Value="_selectedUser"
                           ValueChanged="OnUserChanged">
                    @if (_usersLoaded && Users.Count > 0)
                    {
                        @foreach (var user in Users)
                        {
                            <MudSelectItem Value="@user">@($"{user.FullName} ({user.Username})")</MudSelectItem>
                        }
                    }
                </MudSelect>
            }

            @* --- Service field --- *@
            @if (ServiceId.HasValue)
            {
                <MudTextField
                    Label="خدمت / سرویس"
                    Value="@(_selectedService?.Title ?? string.Empty)"
                    Variant="Variant.Text"
                    Required="true"
                    ReadOnly="true"
                    Disabled="@(!_servicesLoaded)"/>
            }
            else
            {
                <MudSelect T="ClinicServiceResponse"
                           Label="خدمت / سرویس"
                           Variant="Variant.Text"
                           Required="true"
                           Disabled="@(!_servicesLoaded || ServiceId.HasValue)"
                           Value="_selectedService"
                           ValueChanged="OnServiceChanged">
                    @if (_servicesLoaded && Services.Count > 0)
                    {
                        @foreach (var service in Services)
                        {
                            <MudSelectItem Value="@service">@service.Title</MudSelectItem>
                        }
                    }
                </MudSelect>
            }

            @* --- Date picker --- *@
            <MudDatePicker Label="تاریخ"
                           Variant="Variant.Text"
                           Culture="@(new CultureInfo("fa-IR"))"
                           Date="_selectedDate"
                           DateChanged="OnDateChanged"
                           Required="true"/>

            @* --- Slots --- *@
            <MudStack Spacing="1">
                <MudText Typo="Typo.subtitle2">ساعت</MudText>

                @if (_loadingSlots)
                {
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2"/>
                        <MudText>در حال دریافت زمان‌های خالی…</MudText>
                    </MudStack>
                }
                else if (_slots.Count > 0)
                {
                    <MudSelect T="string"
                               Label="انتخاب از زمان‌های خالی"
                               Variant="Variant.Text"
                               Required="true"
                               Value="_selectedSlot"
                               ValueChanged="OnSlotSelected">
                        @foreach (var slot in _slots)
                        {
                            <MudSelectItem Disabled="slot.Value" Value="@slot.Key">@slot.Key</MudSelectItem>
                        }
                    </MudSelect>

                    <MudText Color="Color.Success" Typo="Typo.caption">
                        @($"تعداد زمان‌های موجود: {_slots.Count}")
                    </MudText>
                }
                else if (_selectedService is not null && _selectedDate is not null)
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        برای این تاریخ، زمان خالی یافت نشد. لطفاً تاریخ دیگری را انتخاب کنید.
                    </MudAlert>
                }
            </MudStack>

            <MudTextField @bind-Value="Model.Notes"
                          Label="توضیحات"
                          Variant="Variant.Text"
                          AutoGrow="true"
                          Placeholder="توضیحات اضافی..."/>

        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">انصراف</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Save"
                   Disabled="@IsInvalid()"
                   StartIcon="@MaterialIcons.Filled.Save">
            ذخیره
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public Action UpdateUi { get; set; } = default!;
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    public CreateAppointmentCommand Model { get; set; } = new();
    [Parameter] public bool IsPatient { get; set; } = true;
    [Parameter] public Guid? ServiceId { get; set; }
    [Parameter] public long? UserId { get; set; }

    private readonly List<ClinicServiceResponse> Services = new();
    public List<UserListItemResponse> Users { get; set; } = new();

    private UserListItemResponse?  _selectedUser;
    private ClinicServiceResponse? _selectedService;

    private bool _usersLoaded;
    private bool _servicesLoaded;

    // تاریخ و اسلات‌ها
    private DateTime?                _selectedDate;
    private bool                     _loadingSlots;
    private Dictionary<string, bool> _slots = new();
    private string?                  _selectedSlot; // HH:mm

    // لغو درخواست‌های قبلی اسلات
    private CancellationTokenSource? _slotCts;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load services
            if (!ServiceId.HasValue)
            {
                var services = await Mediator.Send(new ListClinicServicesRequest());
                Services.Clear();

                if (services is not null)
                    Services.AddRange(services.Where(s => s is not null)!);

                _servicesLoaded = true;
            }
            else
            {
                var svc = await Mediator.Send(new GetClinicServiceByIdRequest(ServiceId.Value));
                Services.Clear();

                if (svc is not null)
                {
                    Services.Add(svc);
                    _selectedService = svc;
                    Model.ServiceId  = svc.Id;
                }

                _servicesLoaded = true;
            }

            if (Services.Count == 0)
            {
                Snackbar.ShowInfo("خدمتی برای انتخاب وجود ندارد.");
                MudDialog.Close();
                return;
            }

            // Load user
            if (UserId.HasValue)
            {
                var me = await Mediator.Send(new UserInfoByIdRequest(UserId.Value));
                _selectedUser = me?.Adapt<UserListItemResponse>();
                _usersLoaded  = true;

                if (_selectedUser is not null)
                {
                    Model.PatientFullName = _selectedUser.FullName;
                    Model.PatientPhone    = _selectedUser.Username; // یا PhoneNumber اگر دارید
                }
            }
            else if (!IsPatient)
            {
                var usersRes = await Mediator.Send(new UsersQueryRequest
                {
                    IsSecretaries = false,
                    Page          = 1,
                    PageSize      = int.MaxValue
                });

                Users        = usersRes?.Items?.Where(u => u is not null).ToList() ?? new List<UserListItemResponse>();
                _usersLoaded = true;
            }
            else
            {
                var me = await Mediator.Send(new UserInfoRequest());
                _selectedUser = me?.Adapt<UserListItemResponse>();
                _usersLoaded  = true;

                if (_selectedUser is not null)
                {
                    Model.PatientFullName = _selectedUser.FullName;
                    Model.PatientPhone    = _selectedUser.Username; // یا PhoneNumber اگر دارید
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.ShowError($"خطا در بارگذاری داده‌ها: {ex.Message}");
            MudDialog.Close();
        }
    }

    /* ------------------- همگام‌سازی‌ها ------------------- */

    private void OnUserChanged(UserListItemResponse? user)
    {
        _selectedUser = user;

        if (user is null)
        {
            Model.PatientFullName = null;
            Model.PatientPhone    = null;
            return;
        }

        Model.PatientFullName = user.FullName;
        Model.PatientPhone    = user.Username;
    }

    private async Task OnServiceChanged(ClinicServiceResponse? svc)
    {
        _selectedService = svc;
        Model.ServiceId  = svc?.Id ?? Guid.Empty;

        ResetSlots();
        await TryLoadSlotsAsync();
    }

    private async Task OnDateChanged(DateTime? date)
    {
        _selectedDate = date;

        if (date.HasValue)
            Model.Date = DateOnly.FromDateTime(date.Value);
        else
            Model.Date = default; // if nullable: Model.Date = null;

        ResetSlots();
        await TryLoadSlotsAsync();
    }

    private void OnSlotSelected(string? hhmm)
    {
        _selectedSlot = hhmm;
        Model.Start   = hhmm ?? string.Empty;
    }

    private void ResetSlots()
    {
        _slots.Clear();
        _selectedSlot = null;
        Model.Start   = string.Empty;
    }

    /* ------------------- گرفتن اسلات‌ها با لغوپذیری ------------------- */

    private async Task TryLoadSlotsAsync()
    {
        var userId = UserId ?? _selectedUser?.Id;

        if (_selectedService is null || _selectedDate is null || userId is null)
        {
            _loadingSlots = false;
            StateHasChanged();
            return;
        }

        _slotCts?.Cancel();
        _slotCts = new CancellationTokenSource();
        var token = _slotCts.Token;

        _loadingSlots = true;
        StateHasChanged();

        try
        {
            var dateOnly = DateOnly.FromDateTime(_selectedDate.Value);
            var req      = new GetAvailableSlotsRequest(dateOnly, _selectedService.Id, userId.Value);

            var result = await Mediator.Send(req, token);
            if (token.IsCancellationRequested) return;

            _slots = result ?? new();

            // Optional: پیش‌انتخاب اولین اسلات
            if (_slots.Count > 0)
            {
                _selectedSlot = _slots.First().Key;
                Model.Start   = _selectedSlot;
            }
        }
        catch (OperationCanceledException)
        {
            /* ignore */
        }
        catch (Exception ex)
        {
            Snackbar.ShowError($"دریافت زمان‌های خالی ناموفق بود: {ex.Message}");
            _slots.Clear();
        }
        finally
        {
            if (!token.IsCancellationRequested)
            {
                _loadingSlots = false;
                StateHasChanged();
            }
        }
    }

    /* ------------------- اکشن‌ها ------------------- */

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Save()
    {
        if (_selectedService is not null)
            Model.ServiceId = _selectedService.Id;

        if (_selectedUser is not null)
        {
            Model.PatientFullName ??= _selectedUser.FullName;
            Model.PatientPhone    ??= _selectedUser.Username;
        }

        await Mediator.Send(Model);
        MudDialog.Close();
        UpdateUi?.Invoke(); // Trigger parent update
    }

    /* ------------------- اعتبارسنجی ------------------- */

    private bool IsInvalid()
    {
        var hasTime = !string.IsNullOrWhiteSpace(Model.Start);

        return Model.ServiceId == Guid.Empty
               || _selectedDate is null
               || !hasTime
               || string.IsNullOrWhiteSpace(Model.PatientFullName)
               || string.IsNullOrWhiteSpace(Model.PatientPhone);
    }

    public void Dispose()
    {
        _slotCts?.Cancel();
        _slotCts?.Dispose();
    }
}
