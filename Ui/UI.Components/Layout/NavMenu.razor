@using App.Applications.Users.Queries.GetUserInfo
@using Microsoft.AspNetCore.Components.Authorization
@using UI.Components.Common.BaseComponents.Dialogs
@using UI.Components.Common.BaseComponents.Picture
<MudNavMenu Margin="Margin.Normal" Rounded Bordered Dense>

    <!-- عمومی -->
    <MudNavLink Href="/" Icon="@Icons.Filled.Home" IconColor="Color.Primary">
        صفحه اصلی
    </MudNavLink>

    <!-- Doctor (super admin) -->
    <AuthorizeView Roles="Doctor">
        <Authorized Context="auth">
            <MudNavGroup Title="ثبت‌نام" Icon="@Icons.Filled.PersonAdd" IconColor="Color.Tertiary">
                <MudNavLink OnClick="OpenRegisterDialog" Icon="@Icons.Filled.PersonAdd" IconColor="Color.Success">
                    @(auth.User.IsInRole("Doctor") ? "ثبت‌نام (بیمار,منشی)" : "ثبت‌نام بیمار")
                </MudNavLink>
                <MudNavLink Href="/appointments" Icon="@Icons.Filled.CalendarMonth" IconColor="Color.Info">
                    @(auth.User.IsInRole("Doctor") ? "رزرو نوبت" : "رزرو نوبت")
                </MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <!-- Patient, Secretary, Doctor can see patient menu -->
    <AuthorizeView Roles="Patient,Secretary,Doctor">
        <Authorized Context="auth">
            <MudNavGroup Title="@(auth.User.IsInRole("Patient")                             ? "پنل بیمار" :
                                auth.User.IsInRole("Secretary") ? "پنل بیمار (دستیار)" :
                                                                  "پنل بیمار")">

                <MudNavLink Href="/patient/appointments" Icon="@Icons.Filled.EventAvailable" IconColor="Color.Success">
                    @(auth.User.IsInRole("Patient") ? "نوبت‌های من" : "نوبت‌های بیماران")
                </MudNavLink>

                <MudNavLink Href="/patient/history" Icon="@Icons.Filled.History" IconColor="Color.Info">
                    @(auth.User.IsInRole("Patient") ? "سوابق نوبت من" : "سوابق نوبت بیماران")
                </MudNavLink>

                <MudNavLink Href="/patient/cancel" Icon="@Icons.Filled.Cancel" IconColor="Color.Error">
                    @(auth.User.IsInRole("Patient") ? "لغو نوبت من" : "لغو نوبت بیماران")
                </MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <!-- Secretary -->
    <AuthorizeView Roles="Secretary,Doctor">
        <Authorized Context="auth">
            <MudNavLink Href="/secretary/book" Icon="@Icons.Filled.PersonAddAlt1" IconColor="Color.Success">
                @(auth.User.IsInRole("Secretary") ? "رزرو برای بیمار" : "رزرو برای بیمار")
            </MudNavLink>
            <MudNavLink Href="/secretary/patients" Icon="@Icons.Filled.Group" IconColor="Color.Info">
                @(auth.User.IsInRole("Secretary") ? "مدیریت بیماران" : "مدیریت بیماران")
            </MudNavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Doctor (super admin only) -->
    <AuthorizeView Roles="Doctor">
        <Authorized>
            <MudNavLink Href="/doctor/schedule" Icon="@Icons.Filled.Schedule" IconColor="Color.Info">
                تعریف بازه‌های زمانی
            </MudNavLink>
            <MudNavLink Href="/doctor/agenda" Icon="@Icons.Filled.ViewAgenda" IconColor="Color.Primary">
                لیست نوبت‌های روزانه
            </MudNavLink>
            <MudNavLink Href="/doctor/manage" Icon="@Icons.Filled.EditCalendar" IconColor="Color.Warning">
                مدیریت/جابجایی نوبت
            </MudNavLink>
            <MudNavLink Href="/reports/appointments" Icon="@Icons.Filled.Assessment" IconColor="Color.Secondary">
                گزارش همه نوبت‌ها
            </MudNavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Logged in -->
    <AuthorizeView>
        <Authorized Context="auth">
            <MudDivider Class="my-2"/>
            <MudNavLink OnClick="OpenUserInfo" IconColor="Color.Primary">
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.FlexStart">
                    <MudAvatar>
                        <ServerImage Src="@StateProvider.User?.Profile"/>
                    </MudAvatar>
                    <MudText>
                        @(auth.User.Identity?.Name)
                    </MudText>
                    <MudText>
                        (@GetRoleName(auth.User))
                    </MudText>
                </MudStack>

            </MudNavLink>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>

@code {

    private string GetRoleName(System.Security.Claims.ClaimsPrincipal user)
    {
        if (user.IsInRole("Doctor")) return "دکتر";
        if (user.IsInRole("Secretary")) return "منشی";
        if (user.IsInRole("Patient")) return "بیمار";
        return "کاربر";
    }

    private async Task OpenRegisterDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            FullWidth        = true,
            MaxWidth         = MaxWidth.Small
        };


        await DialogService.ShowAsync<RegisterDialog>("ثبت‌نام", options);
    }


    private async Task OpenUserInfo()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth         = MaxWidth.Medium,
            FullWidth        = true,
            CloseButton      = true,
            Position         = DialogPosition.Center
        };

        var user = await Mediator.Send(new GetUserInfoQuery());


        var parameters = new DialogParameters
        {
            {
                "Model", user
            },
            {
                "AllowEdit", (!StateProvider.User?.RolesList?.Contains("Patient") ?? false)
            }
        };


        await DialogService.ShowAsync<ProfileInfoDialog>("اطلاعات کاربر", parameters, options);
    }

}
